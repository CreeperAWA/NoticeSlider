<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0" />
  <link rel="icon" type="image/png" href="xwgj.png">
  <title>消息提醒</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    /* 全屏背景图 */
    .fullscreen-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: url('./qyz.jpg') no-repeat center center;
      background-size: cover;
      z-index: -2;
    }

    /* 主容器：缩放画布 */
    #container {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      transform-origin: center center;
      z-index: 1;
    }

    /* 设计稿尺寸画布 */
    #game-area {
      width: 1920px;
      height: 1080px;
      position: relative;
      color: white;
    }

    /* 消息提醒栏 */
    #root {
      position: absolute;
      top: 50px;
      left: 0;
      width: 100%;
      z-index: 100;
    }
    
    .main-content {
      display: flex;
      padding: 0 93px;
      height: 128px;
      line-height: 128px;
      background: rgba(0, 0, 0, 0.6);
    }
    
    .label {
      width: 305px;
      padding-left: 65px;
      background: url('./s↑b↓.svg') no-repeat center;
      color: #3b9fdc;
      position: relative;
      z-index: 2;
      font-size: 48px;
    }
    
    .message {
      flex: 1;
      overflow: hidden;
      white-space: nowrap;
      color: #fff;
      position: relative;
      height: 100%;
      z-index: 1;
    }
    
    #message-slider-box {
      position: absolute;
      height: 100%;
      line-height: 128px;
      font-size: 48px;
      font-weight: normal;
      will-change: auto;
      transform-style: preserve-3d;
      backface-visibility: hidden;
      perspective: 1000;
    }

    /* 横屏提示 */
    #orientation-tip {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.60);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 48px;
      z-index: 9999;
      text-align: center;
      line-height: 1.6;
    }
    #orientation-tip svg {
      width: 120px; height: 120px; margin-bottom: 30px;
    }
    .close-tip {
      margin-top: 40px;
      padding: 15px 30px;
      background: #333;
      font-size: 32px;
      border-radius: 15px;
      cursor: pointer;
    }

    /* 音频播放失败提示 */
    .audio-tip {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 1);
      color: #000;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 8px;
      z-index: 9998;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      animation: fadeInOut 1s ease-in-out infinite alternate;
    }

    @keyframes fadeInOut {
      from { opacity: 0.7; }
      to   { opacity: 1; }
    }

    /* 隐藏音频控件 */
    #bgMusic {
      display: none;
    }
  </style>
</head>
<body>

  <!-- 全屏背景图 -->
  <div class="fullscreen-bg"></div>

  <!-- 消息提醒栏 -->
  <div id="root">
    <div class="main-content">
      <div class="label">消息提醒：</div>
      <div class="message">
        <div id="message-slider-box"></div>
      </div>
    </div>
  </div>

  <!-- 横屏提示 -->
  <div id="orientation-tip">
    <svg t="1754107465667" class="icon" viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2693">
      <path d="M416 352c-38.4 0-64 25.6-64 64v192c0 38.4 25.6 64 64 64h192c38.4 0 64-25.6 64-64v-192c0-38.4-25.6-64-64-64h-192z m192 256h-192v-192h192v192zM928 704h-192c-19.2 0-32 12.8-32 32s12.8 32 32 32h140.8c-83.2 121.6-224 192-364.8 192s-275.2-64-358.4-179.2c-12.8-12.8-32-19.2-44.8-6.4-12.8 12.8-19.2 32-6.4 44.8C198.4 947.2 352 1024 512 1024c147.2 0 288-64 384-172.8v76.8c0 19.2 12.8 32 32 32s32-12.8 32-32v-192c0-19.2-12.8-32-32-32zM320 288c0-19.2-12.8-32-32-32H147.2C230.4 134.4 364.8 64 512 64c140.8 0 275.2 70.4 358.4 179.2 12.8 12.8 32 19.2 44.8 6.4 12.8-12.8 19.2-32 6.4-44.8C825.6 76.8 672 0 512 0 364.8 0 224 64 128 172.8V96C128 76.8 115.2 64 96 64s-32 12.8-32 32v192c0 19.2 12.8 32 32 32h192c19.2 0 32-12.8 32-32z" fill="#ffffff" p-id="2694"></path>
    </svg>
    请将设备横屏<br>以获得最佳体验
    <div class="close-tip" onclick="closeTip()">继续浏览</div>
  </div>

  <!-- 主画布 -->
  <div id="container">
    <div id="game-area">
      <!-- 内容可添加 -->
    </div>
  </div>

  <!-- 背景音乐 - 动态src -->
  <audio id="bgMusic" loop></audio>

  <script>
    const container = document.getElementById('container');
    const tip = document.getElementById('orientation-tip');
    const bgMusic = document.getElementById('bgMusic');
    const messageSliderBox = document.getElementById('message-slider-box');
    let isAudioTipShown = false;
    let animationFrameId = null;
    let positionLeft = 0;
    let speed = 200; // 与 SSA 原版保持一致的速度
    let isScrollInitialized = false;
    let isAnimationRunning = false;
    
    // 添加egg变量、自定义消息和自定义音乐 - 检查URL参数
    const urlParams = new URLSearchParams(window.location.search);
    const egg = urlParams.get('zhaoshuo') === 'shuoshu';
    const customMessage = urlParams.get('message');
    const customMusic = urlParams.get('music');

    // 设置背景音乐源
    if (customMusic) {
      // 解码URL参数
      const musicSrc = decodeURIComponent(customMusic);
      // 创建source元素
      const source = document.createElement('source');
      source.src = musicSrc;
      source.type = 'audio/mpeg';
      bgMusic.appendChild(source);
    } else {
      // 默认音乐
      const source = document.createElement('source');
      source.src = './jl.mp3';
      source.type = 'audio/mpeg';
      bgMusic.appendChild(source);
    }

    // 缩放适配
    function resize() {
      const designWidth = 1920;
      const designHeight = 1080;
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;

      // 横屏检测
      if (windowWidth <= windowHeight && window.innerHeight > 500) {
        tip.style.display = 'flex';
        container.style.opacity = 0;
        return;
      } else {
        tip.style.display = 'none';
        container.style.opacity = 1;
      }

      const scaleX = windowWidth / designWidth;
      const scaleY = windowHeight / designHeight;
      const scale = Math.min(scaleX, scaleY);

      container.style.transform = `scale(${scale})`;
    }

    // 初始化消息滚动
    function initMessageScroll() {
      // 防止重复初始化
      if (isScrollInitialized) return;
      isScrollInitialized = true;
      
      const messageContent = document.createElement('span');
      messageContent.style.marginRight = '150px';
      messageContent.style.fontWeight = 'normal';
      messageContent.style.color = '#fff';
      
      // 根据参数决定显示什么内容（优先级：自定义消息 > egg > 默认消息）
      if (customMessage) {
        // 解码URL参数，确保特殊字符正确显示
        messageContent.textContent = decodeURIComponent(customMessage);
      } else if (egg) {
        messageContent.textContent = "某中学物理老师，曾于2024年11月10日为全校希沃一体机安装希沃管家 名言：「这是你的私人财产吗？」 「谁给火绒设的密码？」 「这个得请希沃的工程师来给这个希沃做恢复。」";
      } else {
        messageContent.textContent = "无人扶我青云志，我自踏雪至山巅。若是命中无此运，亦可孤身登昆仑。红尘赠我三尺剑，酒看瘦马一世街。世人朝路乃绝涧，独见众生止步前。海到尽头天作岸，山登绝顶我为峰。如若东山能再起，大鹏展翅九万里。一入红尘梦易真，一朝悟透心境名。一朝悟道见真我，昔日枷锁皆云烟。天门将至百运开，拂尘轻笑问仙来。";
      }
      
      messageSliderBox.innerHTML = '';
      messageSliderBox.appendChild(messageContent);
      
      // 使用双重requestAnimationFrame确保DOM完全渲染
      requestAnimationFrame(() => {
        // 从屏幕右侧开始，确保完全在屏幕外
        positionLeft = window.innerWidth;
        messageSliderBox.style.transform = `translateX(${positionLeft}px)`;
        
        // 再次使用requestAnimationFrame确保位置已应用
        requestAnimationFrame(() => {
          // 确保位置再次确认
          positionLeft = window.innerWidth;
          messageSliderBox.style.transform = `translateX(${positionLeft}px)`;
          
          // 延迟1帧启动滚动，确保初始位置稳定
          setTimeout(() => {
            startMessageScroll();
          }, 16);
        });
      });
    }

    // 启动消息滚动
    function startMessageScroll() {
      if (isAnimationRunning) {
        cancelAnimationFrame(animationFrameId);
      }
      
      isAnimationRunning = true;
      
      // 重置位置到屏幕右侧（双重保险）
      positionLeft = window.innerWidth;
      messageSliderBox.style.transform = `translateX(${positionLeft}px)`;
      
      function animate() {
        // 实时获取容器宽度
        const containerWidth = messageSliderBox.offsetWidth;
        
        positionLeft -= speed / 60; // 每帧移动的距离
        messageSliderBox.style.transform = `translateX(${positionLeft}px)`;
        
        // 如果消息已经完全移出屏幕左侧，重置到右侧
        if (positionLeft + containerWidth < 0) {
          positionLeft = window.innerWidth;
        }
        
        animationFrameId = requestAnimationFrame(animate);
      }
      
      animate();
    }

    // ✅ 封装：启动滚动文字（在音乐播放成功后调用）
    function startScrollText() {
      initMessageScroll();
    }

    // 显示音频播放失败提示
    function showAudioTip() {
      if (isAudioTipShown) return;
      isAudioTipShown = true;

      // 清除已有的提示
      const existingTip = document.querySelector('.audio-tip');
      if (existingTip) {
        document.body.removeChild(existingTip);
      }

      const audioTip = document.createElement('div');
      audioTip.className = 'audio-tip';
      audioTip.innerText = '自动播放BGM失败，点击屏幕任意位置开启背景音乐（悲';
      document.body.appendChild(audioTip);

      const tryPlay = () => {
        // 点击后立即移除提示
        if (audioTip.parentNode) {
          document.body.removeChild(audioTip);
        }
        isAudioTipShown = false;
        isScrollInitialized = false; // 重置滚动初始化状态
        isAnimationRunning = false; // 重置动画状态

        bgMusic.play()
          .then(() => {
            console.log('音乐已播放');
            startScrollText();
          })
          .catch(err => {
            console.warn('播放失败，2秒后重试提示:', err);
            setTimeout(showAudioTip, 2000);
          });

        // 移除事件监听
        document.removeEventListener('touchstart', tryPlay);
        document.removeEventListener('click', tryPlay);
      };

      // 绑定一次性事件
      document.addEventListener('touchstart', tryPlay, { once: true });
      document.addEventListener('click', tryPlay, { once: true });
    }

    // 尝试自动播放音乐
    function autoPlayMusic() {
      bgMusic.play()
        .then(() => {
          console.log('音乐自动播放成功');
          startScrollText();
        })
        .catch(err => {
          console.warn('自动播放被阻止:', err);
          showAudioTip();
        });
    }

    // 页面加载时立即尝试自动播放
    window.addEventListener('load', () => {
      autoPlayMusic();
      resize();
    });

    // 窗口变化
    window.addEventListener('resize', () => {
      resize();
      
      // 重置滚动位置
      if (isScrollInitialized) {
        const containerWidth = messageSliderBox.offsetWidth;
        positionLeft = window.innerWidth;
        messageSliderBox.style.transform = `translateX(${positionLeft}px)`;
      }
    });
    
    window.addEventListener('orientationchange', () => {
      setTimeout(resize, 300);
    });

    // 关闭横屏提示
    function closeTip() {
      tip.style.display = 'none';
      container.style.opacity = 1;
      resize();
    }
  </script>
</body>
</html>